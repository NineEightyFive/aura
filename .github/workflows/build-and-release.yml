name: Build Installers

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: AURA
  MAIN_CLASS: AuraMain.Main

jobs:

  # ------------------------------------------------------------
  # 1) macOS Intel
  # ------------------------------------------------------------
  macos-intel:
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21 (Intel)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Debug target directory
        run: ls -la target || true

      - name: Locate & rename JAR
        run: |
          echo "Files in target/:"
          ls -la target || true
          if ls target/*-jar-with-dependencies.jar 1> /dev/null 2>&1; then
            JAR=$(ls -1 target/*-jar-with-dependencies.jar | head -n1)
          else
            JAR=$(ls -1 target/*.jar | head -n1)
          fi
          echo "Using: $JAR"
          mv "$JAR" "target/${APP_NAME}.jar"

      - name: Build DMG (Intel)
        run: |
          jpackage \
            --name "${APP_NAME}" \
            --input target \
            --main-jar "${APP_NAME}.jar" \
            --main-class "${MAIN_CLASS}" \
            --type dmg \
            --dest output \
            --icon src/main/resources/img/appicon.icns \
            --java-options "-Xmx512m"

      - name: Upload Intel DMG
        uses: softprops/action-gh-release@v1
        with:
          files: output/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------
  # 2) macOS ARM (M1/M2/M3)
  # ------------------------------------------------------------
  macos-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21 (ARM)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          architecture: aarch64

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Debug target directory
        run: ls -la target || true

      - name: Locate & rename JAR
        run: |
          echo "Files in target/:"
          ls -la target || true
          if ls target/*-jar-with-dependencies.jar 1> /dev/null 2>&1; then
            JAR=$(ls -1 target/*-jar-with-dependencies.jar | head -n1)
          else
            JAR=$(ls -1 target/*.jar | head -n1)
          fi
          echo "Using: $JAR"
          mv "$JAR" "target/${APP_NAME}.jar"

      - name: Build DMG (ARM)
        run: |
          jpackage \
            --name "${APP_NAME}" \
            --input target \
            --main-jar "${APP_NAME}.jar" \
            --main-class "${MAIN_CLASS}" \
            --type dmg \
            --dest output \
            --icon src/main/resources/img/appicon.icns \
            --java-options "-Xmx512m"

      - name: Upload ARM DMG
        uses: softprops/action-gh-release@v1
        with:
          files: output/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------
  # 3) Linux TAR distribution
  # ------------------------------------------------------------
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Debug target directory
        run: ls -la target || true

      - name: Locate & rename JAR
        run: |
          echo "Files in target/:"
          ls -la target || true
          if ls target/*-jar-with-dependencies.jar 1> /dev/null 2>&1; then
            JAR=$(ls -1 target/*-jar-with-dependencies.jar | head -n1)
          else
            JAR=$(ls -1 target/*.jar | head -n1)
          fi
          echo "Using: $JAR"
          mv "$JAR" "target/${APP_NAME}.jar"

      - name: Build Linux archive
        run: |
          jpackage \
            --name "${APP_NAME}" \
            --input target \
            --main-jar "${APP_NAME}.jar" \
            --main-class "${MAIN_CLASS}" \
            --type app-image \
            --dest output \
            --java-options "-Xmx512m"

          cd output
          tar -czf "${APP_NAME}-linux.tar.gz" "${APP_NAME}.app" || \
          tar -czf "${APP_NAME}-linux.tar.gz" "${APP_NAME}" 

      - name: Upload Linux TAR
        uses: softprops/action-gh-release@v1
        with:
          files: output/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------
  # 4) Windows EXE
  # ------------------------------------------------------------
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Debug target directory
        run: ls -la target || true
        shell: bash

      - name: Locate & rename JAR
        shell: pwsh
        run: |
          Write-Host "Files in target:"
          Get-ChildItem target -File | ForEach-Object { $_.Name }
          $shaded = Get-ChildItem target -Filter "*-jar-with-dependencies.jar" -File | Select-Object -First 1
          if ($shaded) {
            $jar = $shaded.FullName
          } else {
            $jar = (Get-ChildItem target -Filter "*.jar" -File | Select-Object -First 1).FullName
          }
          if (-not $jar) {
            throw "No JAR found in target/"
          }
          Rename-Item -Path $jar -NewName ("${env:APP_NAME}.jar")

      - name: Build EXE
        shell: pwsh
        run: |
          jpackage `
            --name "${env:APP_NAME}" `
            --input target `
            --main-jar "${env:APP_NAME}.jar" `
            --main-class "${env:MAIN_CLASS}" `
            --type exe `
            --dest output `
            --win-menu `
            --win-shortcut `
            --win-dir-chooser

      - name: Upload EXE
        uses: softprops/action-gh-release@v1
        with:
          files: output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
