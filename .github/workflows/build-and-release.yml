name: Build AURA Installers

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: AURA
  MAIN_JAR: AURA.jar
  MAIN_CLASS: AuraMain.Main
  OUTPUT_DIR: output

jobs:

  ###########################################
  # LINUX BUILD (.deb or .rpm optional later)
  ###########################################
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build JAR
        run: mvn -B package --file pom.xml

      - name: Locate & rename JAR (Linux)
        run: |
          echo "Files in target/:"
          ls -la target || true

          # Prefer shaded jar
          if ls target/*-jar-with-dependencies.jar 1>/dev/null 2>&1; then
            JAR=$(ls -1 target/*-jar-with-dependencies.jar | head -n1)
          else
            JAR=$(ls -1 target/*.jar | head -n1)
          fi

          echo "Found JAR: $JAR"

          # Conditional rename
          if [ "$JAR" != "target/${APP_NAME}.jar" ]; then
            mv "$JAR" "target/${APP_NAME}.jar"
            echo "Renamed to ${APP_NAME}.jar"
          else
            echo "JAR already named correctly, skipping rename."
          fi

      - name: Prepare output directory
        run: mkdir -p $OUTPUT_DIR

      - name: Place installer artifact
        run: cp target/${APP_NAME}.jar $OUTPUT_DIR/${APP_NAME}-linux.jar

      - uses: actions/upload-artifact@v3
        with:
          name: aura-linux-jar
          path: ${{ env.OUTPUT_DIR }}/*


  ###########################################
  # WINDOWS BUILD (.exe)
  ###########################################
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build JAR
        run: mvn -B package --file pom.xml

      - name: Rename JAR (Windows)
        shell: pwsh
        run: |
          $jar = Get-ChildItem "target" -Filter "*jar-with-dependencies.jar" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $jar) {
            $jar = Get-ChildItem "target" -Filter "*.jar" | Select-Object -First 1
          }

          echo "Found JAR: $($jar.FullName)"

          if ($jar.Name -ne "${env:APP_NAME}.jar") {
            Rename-Item $jar.FullName "${env:APP_NAME}.jar"
          }

      - name: Build EXE with jpackage
        run: |
          jpackage `
            --type exe `
            --name "${env:APP_NAME}" `
            --input target `
            --main-jar "${env:MAIN_JAR}" `
            --main-class "${env:MAIN_CLASS}" `
            --win-dir-chooser `
            --win-shortcut `
            --win-menu `
            --dest "${env:OUTPUT_DIR}"

      - uses: actions/upload-artifact@v3
        with:
          name: aura-windows-exe
          path: ${{ env.OUTPUT_DIR }}/*


  ###########################################
  # macOS ARM (Apple Silicon)
  ###########################################
  macos-arm:
    runs-on: macos-14   # ARM64 runner

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build JAR
        run: mvn -B package --file pom.xml

      - name: Rename JAR (macOS ARM)
        run: |
          if ls target/*jar-with-dependencies.jar 1>/dev/null 2>&1; then
            JAR=$(ls -1 target/*jar-with-dependencies.jar | head -n1)
          else
            JAR=$(ls -1 target/*.jar | head -n1)
          fi

          if [ "$(basename $JAR)" != "${APP_NAME}.jar" ]; then
            mv "$JAR" "target/${APP_NAME}.jar"
          fi

      - name: Create DMG (ARM)
        run: |
          jpackage \
            --type dmg \
            --name "$APP_NAME" \
            --input target \
            --main-jar "$MAIN_JAR" \
            --main-class "$MAIN_CLASS" \
            --icon src/main/resources/img/appicon.icns \
            --dest "$OUTPUT_DIR"

      - uses: actions/upload-artifact@v3
        with:
          name: aura-macos-arm
          path: ${{ env.OUTPUT_DIR }}/*


  ###########################################
  # macOS INTEL
  ###########################################
  macos-intel:
    runs-on: macos-13   # Intel runner (x86_64)

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build JAR
        run: mvn -B package --file pom.xml

      - name: Rename JAR (macOS Intel)
        run: |
          if ls target/*jar-with-dependencies.jar 1>/dev/null 2>&1; then
            JAR=$(ls -1 target/*jar-with-dependencies.jar | head -n1)
          else
            JAR=$(ls -1 target/*.jar | head -n1)
          fi

          if [ "$(basename $JAR)" != "${APP_NAME}.jar" ]; then
            mv "$JAR" "target/${APP_NAME}.jar"
          fi

      - name: Create DMG (Intel)
        run: |
          jpackage \
            --type dmg \
            --name "$APP_NAME" \
            --input target \
            --main-jar "$MAIN_JAR" \
            --main-class "$MAIN_CLASS" \
            --icon src/main/resources/img/appicon.icns \
            --dest "$OUTPUT_DIR"

      - uses: actions/upload-artifact@v3
        with:
          name: aura-macos-intel
          path: ${{ env.OUTPUT_DIR }}/*


  ###########################################
  # CREATE RELEASE & UPLOAD ALL FILES
  ###########################################
  release:
    needs: [build-linux, build-windows, macos-arm, macos-intel]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v3
        with:
          path: ${{ env.OUTPUT_DIR }}

      - name: List output files
        run: ls -R $OUTPUT_DIR

      - name: Create Release with Assets
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.OUTPUT_DIR }}/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
