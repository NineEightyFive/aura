name: Build AURA Releases

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: AURA
  MAIN_JAR: AURA.jar
  MAIN_CLASS: AuraMain.Main
  OUTPUT_DIR: output

jobs:
  setup-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

  # -------------------------------
  # macOS INTEL BUILD
  # -------------------------------
  build-macos-intel:
    needs: setup-version
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build Project
        run: mvn -B -DskipTests package

      - name: Rename JAR
        run: mv target/*.jar "target/${APP_NAME}.jar"

      - name: Build Intel macOS DMG
        run: |
          mkdir -p output
          jpackage \
            --type dmg \
            --name "$APP_NAME" \
            --app-version "${{ needs.setup-version.outputs.version }}" \
            --input target \
            --main-jar "${APP_NAME}.jar" \
            --main-class "$MAIN_CLASS" \
            --icon src/main/resources/img/appicon.icns \
            --dest output \
            --runtime-image $(/usr/libexec/java_home)/jre

      - uses: actions/upload-artifact@v4
        with:
          name: macos-intel
          path: output/*

  # -------------------------------
  # macOS ARM BUILD
  # -------------------------------
  build-macos-arm:
    needs: setup-version
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Build Project
        run: mvn -B -DskipTests package

      - name: Rename JAR
        run: mv target/*.jar "target/${APP_NAME}.jar"

      - name: Build ARM64 macOS DMG
        run: |
          mkdir -p output
          jpackage \
            --type dmg \
            --name "$APP_NAME" \
            --app-version "${{ needs.setup-version.outputs.version }}" \
            --input target \
            --main-jar "${APP_NAME}.jar" \
            --main-class "$MAIN_CLASS" \
            --icon src/main/resources/img/appicon.icns \
            --dest output \
            --runtime-image $(/usr/libexec/java_home)/jre

      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm
          path: output/*

  # -------------------------------
  # WINDOWS BUILD
  # -------------------------------
  build-windows:
    needs: setup-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - run: mvn -B -DskipTests package

      - run: ren target\\*.jar ${env:APP_NAME}.jar

      - run: |
          mkdir output
          jpackage `
            --type exe `
            --name "$env:APP_NAME" `
            --app-version "${{ needs.setup-version.outputs.version }}" `
            --input target `
            --main-jar "$env:APP_NAME.jar" `
            --main-class "$env:MAIN_CLASS" `
            --icon src/main/resources/img/appicon.ico `
            --dest output `
            --win-menu `
            --win-shortcut `
            --win-dir-chooser `
            --runtime-image "$env:JAVA_HOME\\jre"

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: output/*

  # -------------------------------
  # LINUX BUILD (optional)
  # -------------------------------
  build-linux:
    needs: setup-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - run: sudo apt-get update -y && sudo apt-get install -y fakeroot

      - run: mvn -B -DskipTests package

      - name: Rename JAR
        run: mv target/*.jar "target/${APP_NAME}.jar"

      - name: Build AppImage
        run: |
          mkdir -p output
          jpackage \
            --type app-i
